<!-- build time:Fri Sep 06 2019 14:16:42 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="elasticsearch,"><link rel="alternate" href="/atom.xml" title="wind-mills" type="application/atom+xml"><meta name="description" content="图Elasticsearch在数据湖中的地位1.Elasticsearch部署建议1.1选择合理的硬件配置，尽可能使用SSDElasticsearch最大的瓶颈往往是磁盘读写性能，尤其是随机读取性能。使用SSD（PCI-E接口SSD卡/SATA接口SSD盘）通常比机械硬盘（SATA盘/SAS盘）查询速度快5~10倍，写入性能提升不明显。对于文档检索类查询性能要求较高的场景，建议考虑SSD作为存储，"><meta name="keywords" content="elasticsearch"><meta property="og:type" content="article"><meta property="og:title" content="elasticsearch优化"><meta property="og:url" content="http://yoursite.com/2019/08/30/es/Elasticsearch优化经验/index.html"><meta property="og:site_name" content="wind-mills"><meta property="og:description" content="图Elasticsearch在数据湖中的地位1.Elasticsearch部署建议1.1选择合理的硬件配置，尽可能使用SSDElasticsearch最大的瓶颈往往是磁盘读写性能，尤其是随机读取性能。使用SSD（PCI-E接口SSD卡/SATA接口SSD盘）通常比机械硬盘（SATA盘/SAS盘）查询速度快5~10倍，写入性能提升不明显。对于文档检索类查询性能要求较高的场景，建议考虑SSD作为存储，"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://i.loli.net/2019/08/12/PV7LqxZHncdzmQ5.jpg"><meta property="og:updated_time" content="2019-09-02T09:54:29.561Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="elasticsearch优化"><meta name="twitter:description" content="图Elasticsearch在数据湖中的地位1.Elasticsearch部署建议1.1选择合理的硬件配置，尽可能使用SSDElasticsearch最大的瓶颈往往是磁盘读写性能，尤其是随机读取性能。使用SSD（PCI-E接口SSD卡/SATA接口SSD盘）通常比机械硬盘（SATA盘/SAS盘）查询速度快5~10倍，写入性能提升不明显。对于文档检索类查询性能要求较高的场景，建议考虑SSD作为存储，"><meta name="twitter:image" content="https://i.loli.net/2019/08/12/PV7LqxZHncdzmQ5.jpg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"right",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2019/08/30/es/Elasticsearch优化经验/"><title>elasticsearch优化 | wind-mills</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><a href="https://github.com/wind-mills/wind-mills.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">wind-mills</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">xxx</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-top"><a href="/top/" rel="section"><i class="menu-item-icon fa fa-fw fa-signal"></i><br>阅读排行</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1E92FB;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1E92FB,0 0 5px #1E92FB}.pace .pace-activity{border-top-color:#1E92FB;border-left-color:#1E92FB}</style></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/30/es/Elasticsearch优化经验/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="wind-mills"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="wind-mills"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">elasticsearch优化</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-30T00:00:00+08:00">2019-08-30 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span> </a></span></span><span id="/2019/08/30/es/Elasticsearch优化经验/" class="leancloud_visitors" data-flag-title="elasticsearch优化"><span class="post-meta-divider"></span> <span class="post-meta-item-icon"></span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">7.9k 字 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">32分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>图</p><ul><li>Elasticsearch在数据湖中的地位</li></ul><p><img src="https://i.loli.net/2019/08/12/PV7LqxZHncdzmQ5.jpg" alt="示例"></p><h1 id="1-Elasticsearch部署建议"><a href="#1-Elasticsearch部署建议" class="headerlink" title="1.Elasticsearch部署建议"></a>1.Elasticsearch部署建议</h1><h2 id="1-1选择合理的硬件配置，尽可能使用SSD"><a href="#1-1选择合理的硬件配置，尽可能使用SSD" class="headerlink" title="1.1选择合理的硬件配置，尽可能使用SSD"></a>1.1选择合理的硬件配置，尽可能使用SSD</h2><p>Elasticsearch最大的瓶颈往往是磁盘读写性能，尤其是随机读取性能。使用SSD（PCI-E接口SSD卡/SATA接口SSD盘）通常比机械硬盘（SATA盘/SAS盘）查询速度快5~10倍，写入性能提升不明显。</p><p>对于文档检索类查询性能要求较高的场景，建议考虑SSD作为存储，同时按照1:10的比例配置内存和硬盘。<br>对于日志分析类查询并发要求较低的场景，可以考虑采用机械硬盘作为存储，同时按照1:50的比例配置内存和硬盘。单节点存储数据建议在2TB以内，最大不要超过5TB，避免查询速度慢、系统不稳定。</p><p>在单机存储1TB数据场景下，SATA盘和SSD盘的全文检索性能对比（测试环境：Elasticsearch5.5.3，10亿条人口户籍登记信息，单机16核CPU、64GB内存，12块6TB SATA盘，2块1.5 TB SSD盘）：</p><p>磁盘类型|并发数|QPS|平均检索响应时间|50%请求响应时间|90%请求响应时间|IOPS|<br>—|—|—|—|—|—|—|—|—|—<br>SATA盘|10并发|17|563ms|478ms|994ms|1200<br>SATA盘|50并发|64|773ms|711ms|1155ms|1800<br>SATA盘|100并发|110|902ms|841ms|1225ms|2040<br>SATA盘|200并发|84|2369ms|2335ms|2909ms|2400<br>SSD盘|10并发|94|105ms|90ms|200ms|25400<br>SSD盘|50并发|144|346ms|341ms|411ms|66000<br>SSD盘| 100并发|152|654ms|689ms|791ms|60000<br>SSD盘|200并发|210|950ms|1179ms|1369ms|60000</p><h2 id="1-2-给JVM配置机器一半的内存，但是不建议超过32G"><a href="#1-2-给JVM配置机器一半的内存，但是不建议超过32G" class="headerlink" title="1.2.给JVM配置机器一半的内存，但是不建议超过32G"></a>1.2.给JVM配置机器一半的内存，但是不建议超过32G</h2><p>修改<code>conf/jvm.options</code>配置，<code>-Xms</code>和<code>-Xmx</code>设置为相同的值，推荐设置为机器内存的一半左右，剩余一半留给操作系统缓存使用。</p><p>jvm内存建议不要低于2G，否则有可能因为内存不足导致ES无法正常启动或内存溢出，jvm建议不要超过32G，否则jvm会禁用内存对象指针压缩技术，造成内存浪费。</p><p>机器内存大于64G内存时，推荐配置<code>-Xms30g -Xmx30g</code> 。</p><h2 id="1-3-规模较大的集群配置专有主节点，避免脑裂问题"><a href="#1-3-规模较大的集群配置专有主节点，避免脑裂问题" class="headerlink" title="1.3.规模较大的集群配置专有主节点，避免脑裂问题"></a>1.3.规模较大的集群配置专有主节点，避免脑裂问题</h2><p>Elasticsearch主节点（master节点）负责集群元信息管理、index的增删操作、节点的加入剔除，定期将最新的集群状态广播至各个节点。在集群规模较大时，建议配置专有主节点只负责集群管理，不存储数据，不承担数据读写压力。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">脑裂问题就是集群中出现了多个master，导致集群内部信息混乱，无法对外提供一致信息。</span><br></pre></td></tr></table></figure><blockquote><p>解决方案：避免出现多个master====。====</p><p>根本解决方案：没有。 由于网络原因不可控。</p></blockquote><ul><li><p>关于脑裂的优化：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#一个节点多久ping一次，默认1s</span><br><span class="line">discovery.zen.fd.ping_interval: 1s</span><br><span class="line">##等待ping返回时间，默认30s</span><br><span class="line">discovery.zen.fd.ping_timeout: 10s</span><br><span class="line">##ping超时重试次数，默认3次</span><br><span class="line">discovery.zen.fd.ping_retries: 3</span><br><span class="line">##选举时需要的节点连接数</span><br><span class="line">discovery.zen.minimum_master_nodes=N/2+1</span><br></pre></td></tr></table></figure></li><li><p>拓展：Master的选举机制<br><a href="https://blog.csdn.net/xiaoyu_BD/article/details/82016395" target="_blank" rel="noopener">https://blog.csdn.net/xiaoyu_BD/article/details/82016395</a></p></li></ul><h3 id="1-3-1-master节点与data节点分离"><a href="#1-3-1-master节点与data节点分离" class="headerlink" title="1.3.1.master节点与data节点分离"></a>1.3.1.master节点与data节点分离</h3><blockquote><p>配置如下：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 专有主节点配置(conf/elasticsearch.yml)：</span><br><span class="line">node.master:true</span><br><span class="line">node.data: false</span><br><span class="line">node.ingest:false</span><br><span class="line"></span><br><span class="line"># 数据节点配置(conf/elasticsearch.yml)：</span><br><span class="line">node.master:false</span><br><span class="line">node.data:true</span><br><span class="line">node.ingest:true</span><br></pre></td></tr></table></figure><p>Elasticsearch默认每个节点既是候选主节点，又是数据节点。最小主节点数量参数minimum_master_nodes推荐配置为候选主节点数量一半以上，该配置告诉Elasticsearch当没有足够的master候选节点的时候，不进行master节点选举，等master节点足够了才进行选举。</p><blockquote><p>例如对于3节点集群，最小主节点数量从默认值1改为2。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 最小主节点数量配置(conf/elasticsearch.yml)：</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br></pre></td></tr></table></figure><h3 id="1-3-2-GC算法"><a href="#1-3-2-GC算法" class="headerlink" title="1.3.2.GC算法"></a>1.3.2.GC算法</h3><p>master节点采用(CMS)GC算法，即使GC全局回收，也会及时响应。</p><h3 id="1-3-3-设置discovery-zen-ping-timeout"><a href="#1-3-3-设置discovery-zen-ping-timeout" class="headerlink" title="1.3.3.设置discovery.zen.ping_timeout"></a>1.3.3.设置discovery.zen.ping_timeout</h3><p><code>discovery.zen.ping_timeout（默认3秒）</code>，默认情况下，一个节点会认为，如果master节点在3秒之内没有应答，那么这个节点就是死掉了，而增加这个值，会增加节点等待响应的时间，从一定程度上会减少误判。</p><h3 id="1-3-4-设置选举触发条件"><a href="#1-3-4-设置选举触发条件" class="headerlink" title="1.3.4.设置选举触发条件"></a>1.3.4.设置选举触发条件</h3><p>设置选举触发条件，<code>discovery.zen.minimum_master_nodes:1</code><br>该参数是用于控制选举行为发生的最小集群主节点数量。</p><p>当备选主节点的个数大于等于该参数的值，且备选主节点中有该参数个节点认为主节点挂了，进行选举。</p><p>官方建议为<br><code>（n/2）+1</code>，n为主节点个数（即有资格成为主节点的节点个数），增大该参数，当该值为2时，我们可以设置master的数量为3，这样，挂掉一台，其他两台都认为主节点挂掉了，才进行主节点选举。</p><h3 id="1-3-5-修改data节点的默认的master发现方式"><a href="#1-3-5-修改data节点的默认的master发现方式" class="headerlink" title="1.3.5.修改data节点的默认的master发现方式"></a>1.3.5.修改data节点的默认的master发现方式</h3><p>data节点的默认的master发现方式由multicast修改为unicast</p><p><code>discovery.zen.ping.multicast.enabled: false</code></p><p><code>discovery.zen.ping.unicast.hosts: [&quot;master1&quot;, &quot;master2&quot;, &quot;master3&quot;]</code></p><h2 id="1-4-Linux参数调优"><a href="#1-4-Linux参数调优" class="headerlink" title="1.4.Linux参数调优"></a>1.4.Linux参数调优</h2><blockquote><p>关闭交换分区，防止内存置换降低性能。 将<code>/etc/fstab</code> 文件中包含swap的行注释掉</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.sed -i &apos;/swap/s/^/#/&apos; /etc/fstab</span><br><span class="line">2.swapoff -a</span><br></pre></td></tr></table></figure><blockquote><p>单用户可以打开的最大文件数量，可以设置为官方推荐的65536或更大些</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;* - nofile 655360&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure><blockquote><p>单用户内存地址空间</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;* - as unlimited&quot;&gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure><blockquote><p>单用户文件大小</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;* - fsize unlimited&quot; &gt;&gt;/etc/security/limits.conf</span><br></pre></td></tr></table></figure><blockquote><p>单用户锁定内存</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;* - memlock unlimited&quot; &gt;&gt;/etc/security/limits.conf</span><br></pre></td></tr></table></figure><blockquote><p>单用户线程数调大</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;* - nproc 131072&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure><blockquote><p>单进程可以使用的最大map内存区域数量</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;vm.max_map_count = 655360&quot; &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure><blockquote><p>参数修改立即生效</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><blockquote><p>降低tcp alive time，防止无效链接占用链接数</p></blockquote><h2 id="1-5-参数调优"><a href="#1-5-参数调优" class="headerlink" title="1.5.参数调优"></a>1.5.参数调优</h2><p>开启内存锁，禁止swapping<br>执行linux命令(临时生效)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -l unlimited</span><br></pre></td></tr></table></figure><p>修改主机配置：/etc/security/limits.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br></pre></td></tr></table></figure><blockquote><p>修改es配置：config/elasticsearch.yml</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.memory_lock : true</span><br></pre></td></tr></table></figure><ul><li>调大文件描述符数量<blockquote><p>执行linux命令(临时生效)</p></blockquote></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n 65535</span><br></pre></td></tr></table></figure><blockquote><p>修改linux配置文件：/etc/security/limits.conf</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br></pre></td></tr></table></figure><ul><li>调大最大映射数<blockquote><p>执行linux命令(临时生效)</p></blockquote></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure><blockquote><p>修改linux配置文件：/etc/sysctl.conf</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure><h2 id="1-6-JVM内存溢出处理"><a href="#1-6-JVM内存溢出处理" class="headerlink" title="1.6.JVM内存溢出处理"></a>1.6.JVM内存溢出处理</h2><p>防止es节点内存溢出后处于僵死状态且无法恢复，影响整个集群，在进程出现OOM时让进程宕掉，退出ES集群并引发告警，然后重启。</p><p>在config/jvm.options中增加JVM启动参数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+ExitOnOutOfMemoryError</span><br></pre></td></tr></table></figure><p>==该参数在jdk 1.8.0_92版本上线==</p><h2 id="1-7-GC调优"><a href="#1-7-GC调优" class="headerlink" title="1.7.GC调优"></a>1.7.GC调优</h2><p>ElasticSearch本质上是个Java程序，所以配置JVM垃圾回收器本身也是一个很有意义的工作。我们使用JVM的Xms和Xmx参数来提供指定内存大小，本质上提供的是JVM的堆空间大小，当JVM的堆空间不足的时候就会触发致命的OutOfMemoryException。这意味着要么内存不足，要么出现了内存泄露。处理GC问题，首先要确定问题的源头，一般有两种方案：</p><ol><li><p>开启ElasticSearch上的GC日志</p></li><li><p>使用jstat命令</p></li><li><p>生成内存Dump</p></li></ol><p>关于第一条，在ES的配置文件elasticsearch.yml中有相关的属性可以配置，关于每个属性的用途这里当然说不完。</p><p>第二条，jstat命令可以帮助我们查看JVM堆中各个区的使用情况和GC的耗时情况。</p><p>第三条，最后的办法就是将JVM的堆空间转储到文件中去，实质上是对JVM堆空间的一个快照。</p><p>想了解更多关于JVM本身GC调优方法请参考：<a href="http://www.oracle.com/technetwork/java/javase/gc-tuning-6-140523.html" target="_blank" rel="noopener">link</a></p><p>另外，通过修改ES节点的启动参数，也可以调整GC的方式，但是实质上和上述方法是等同的。</p><h1 id="2-索引性能调优建议"><a href="#2-索引性能调优建议" class="headerlink" title="2.索引性能调优建议"></a>2.索引性能调优建议</h1><h2 id="2-1-设置合理的索引分片数和副本数"><a href="#2-1-设置合理的索引分片数和副本数" class="headerlink" title="2.1.设置合理的索引分片数和副本数"></a>2.1.设置合理的索引分片数和副本数</h2><p>索引分片数建议设置为集群节点的整数倍，初始数据导入时副本数设置为0，生产环境副本数建议设置为1（设置1个副本，集群任意1个节点宕机数据不会丢失；设置更多副本会占用更多存储空间，操作系统缓存命中率会下降，检索性能不一定提升）。</p><p>单节点索引分片数建议不要超过3个，每个索引分片推荐10-40GB大小。索引分片数设置后不可以修改，副本数设置后可以修改。</p><p>Elasticsearch6.X及之前的版本默认索引分片数为5、副本数为1，从Elasticsearch7.0开始调整为默认索引分片数为1、副本数为1。</p><p>不同分片数对写入性能的影响（测试环境：7节点Elasticsearch6.3集群，写入30G新闻数据，单节点56核CPU、380G内存、3TB SSD卡，0副本，20线程写入，每批次提交10M左右数据。）：</p><p>集群索引分片数|单节点索引分片数|写入耗时|<br>—|—|—|—|—|—|—|—<br>2|0/1|600s<br>7|1|327s<br>14|2|258s<br>21|3|211s<br>28|4|211s<br>56|8|214s</p><blockquote><p>索引设置</p></blockquote><figure class="highlight plain"><figcaption><span>-XPUT</span><a href="http://localhost:9200/fulltext001?pretty" target="_blank" rel="noopener">-H 'Content-Type: application/json' -d '</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;refresh_interval&quot;: &quot;30s&quot;,</span><br><span class="line">      &quot;merge.policy.max_merged_segment&quot;: &quot;1000mb&quot;,</span><br><span class="line">      &quot;translog.durability&quot;: &quot;async&quot;,</span><br><span class="line">      &quot;translog.flush_threshold_size&quot;: &quot;2gb&quot;,</span><br><span class="line">      &quot;translog.sync_interval&quot;: &quot;100s&quot;,</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;21&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>mapping设置：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> curl -XPOST http://localhost:9200/fulltext001/doc/_mapping?pretty  -H &apos;Content-Type: application/json&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot; : &#123;</span><br><span class="line">        &quot;_all&quot; : &#123;</span><br><span class="line">            &quot;enabled&quot; : false</span><br><span class="line">         &#125;,</span><br><span class="line">        &quot;properties&quot; : &#123;</span><br><span class="line">          &quot;content&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">            &quot;analyzer&quot;:&quot;ik_max_word&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;id&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>curl -XPUT “<a href="http://localhost:9200/fulltext001/_settings&quot;" target="_blank" rel="noopener">http://localhost:9200/fulltext001/_settings&quot;</a> -H ‘Content-Type: application/json’ -d’<br>{<br>“number_of_replicas”: 1<br>}</p><h2 id="2-2-使用批量请求"><a href="#2-2-使用批量请求" class="headerlink" title="2.2.使用批量请求"></a>2.2.使用批量请求</h2><h3 id="2-2-1-考虑"><a href="#2-2-1-考虑" class="headerlink" title="2.2.1 考虑"></a>2.2.1 考虑</h3><p>如果你在做大批量导入，考虑通过设置 <code>index.number_of_replicas: 0</code>关闭副本。</p><p>把每个索引的 <code>index.refresh_interval</code>改到 -1关闭刷新。导入完毕后再开启副本和刷新。</p><h3 id="2-2-2-说明"><a href="#2-2-2-说明" class="headerlink" title="2.2.2 说明"></a>2.2.2 说明</h3><p>使用批量请求将产生比单文档索引请求好得多的性能。写入数据时调用批量提交接口，推荐每批量提交5~15MB数据。例如单条记录1KB大小，每批次提交10000条左右记录写入性能较优；单条记录5KB大小，每批次提交2000条左右记录写入性能较优。</p><blockquote><p>批量请求接口API：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &quot;http://localhost:9200/_bulk&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;field1&quot; : &quot;value1&quot; &#125;</span><br><span class="line">&#123; &quot;delete&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;create&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;field1&quot; : &quot;value3&quot; &#125;</span><br><span class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;1&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_index&quot; : &quot;test&quot;&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;field2&quot; : &quot;value2&quot;&#125; &#125;</span><br></pre></td></tr></table></figure><h2 id="2-3-通过多进程-线程发送数据"><a href="#2-3-通过多进程-线程发送数据" class="headerlink" title="2.3.通过多进程/线程发送数据"></a>2.3.通过多进程/线程发送数据</h2><p>单线程批量写入数据往往不能充分利用服务器CPU资源，可以尝试调整写入线程数或者在多个客户端上同时向Elasticsearch服务器提交写入请求。与批量调整大小请求类似，只有测试才能确定最佳的worker数量。</p><p>可以通过逐渐增加工作任务数量来测试，直到集群上的I / O或CPU饱和。</p><h2 id="2-4-调大refresh-interval"><a href="#2-4-调大refresh-interval" class="headerlink" title="2.4.调大refresh interval"></a>2.4.调大refresh interval</h2><p>在 Elasticsearch 中，写入和打开一个新段的轻量的过程叫做 refresh 。 默认情况下每个分片会每秒自动刷新一次。这就是为什么我们说 Elasticsearch 是近实时搜索:<br>文档的变化并不是立即对搜索可见，但会在一秒之内变为可见。</p><p>并不是所有的情况都需要每秒刷新。可能你正在使用 Elasticsearch 索引大量的日志文件，你可能想优化索引速度而不是近实时搜索，可以通过设置 <code>refresh_interval</code>，降低每个索引的刷新频率。</p><p>设置<code>refresh interval</code> API:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;http://localhost:9200/index&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;refresh_interval&quot;: &quot;30s&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>refresh_interval</code> 可以在既存索引上进行动态更新。 在生产环境中，当你正在建立一个大的新索引时，可以先关闭自动刷新，待开始使用该索引时，再把它们调回来：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;http://localhost:9200/index/_settings&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123; &quot;refresh_interval&quot;: -1 &#125;&apos;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;http://localhost:9200/index/_settings&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123; &quot;refresh_interval&quot;: &quot;1s&quot; &#125;&apos;</span><br></pre></td></tr></table></figure><h2 id="2-5-设计mapping配置合适的字段类型"><a href="#2-5-设计mapping配置合适的字段类型" class="headerlink" title="2.5.设计mapping配置合适的字段类型"></a>2.5.设计mapping配置合适的字段类型</h2><p>Elasticsearch在写入文档时，如果请求中指定的索引名不存在，会自动创建新索引，并根据文档内容猜测可能的字段类型。但这往往不是最高效的，我们可以根据应用场景来设计合理的字段类型。</p><p>例如写入一条记录：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> curl -XPUT &quot;http://localhost:9200/twitter/doc/1?pretty&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot;: &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot;: &quot;2009-11-15T13:12:00&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;Trying out Elasticsearch, so far so good?&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>查询Elasticsearch自动创建的索引mapping，会发现将<code>post_date</code>字段自动识别为date类型，但是message和user字段被设置为text、keyword冗余字段，造成写入速度降低、占用更多磁盘空间。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &quot;http://localhost:9200/twitter&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;twitter&quot;: &#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;doc&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;message&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;post_date&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;user&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">      &quot;index&quot;: &#123;</span><br><span class="line">        &quot;number_of_shards&quot;: &quot;5&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot;: &quot;1&quot;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据业务场景设计索引配置合理的分片数、副本数，设置字段类型、分词器。如果不需要合并全部字段，禁用<code>_all</code>字段，通过<code>copy_to</code>来合并字段。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> curl -XPUT &quot;http://localhost:9200/twitter?pretty&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;20&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &quot;http://localhost:9200/twitter/doc/_mapping?pretty&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot; : &#123;</span><br><span class="line">        &quot;_all&quot; : &#123;</span><br><span class="line">        &quot;enabled&quot; : false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;properties&quot; : &#123;</span><br><span class="line">          &quot;user&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;post_date&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;date&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;message&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">            &quot;analyzer&quot; : &quot;cjk&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-索引配置"><a href="#2-6-索引配置" class="headerlink" title="2.6.索引配置"></a>2.6.索引配置</h2><ul><li><p><code>settings:{efresh_interval}</code>：数据写入刷新间隔，默认1s，调整增加该值可以减少写入压力、增加写入速度，如设为60</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;settings&quot;: &#123;</span><br><span class="line">  &quot;refresh_interval&quot;: &quot;60s&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>mappings:{dynamic}</code>： 禁止es自动创建字段，仅允许预先设定好的字段存入es，防止索引结构混乱</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;mappings&quot;: &#123;</span><br><span class="line">   &quot;mytype&quot;: &#123;</span><br><span class="line">     &quot;dynamic&quot;: false</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>all</code>：建议禁用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;_all&quot;: &#123;</span><br><span class="line">   &quot;enable&quot;: false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>keyword</code>字段属性: ingore_above超过多少字符不写入，keyword一般用于精确查询，不能写入太长。</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">    &quot;ingore_above&quot;: 1000</span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>index</code>属性：将 不作为查询字段的index值设为false</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;index&quot;: &quot;false&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="3-查询性能调优建议"><a href="#3-查询性能调优建议" class="headerlink" title="3.查询性能调优建议"></a>3.查询性能调优建议</h1><h2 id="3-1-使用过滤器缓存和分片查询缓存"><a href="#3-1-使用过滤器缓存和分片查询缓存" class="headerlink" title="3.1.使用过滤器缓存和分片查询缓存"></a>3.1.使用过滤器缓存和分片查询缓存</h2><p>ES中的查询操作分为2种：查询（query）和过滤（filter），查询默认会计算每个返回文档的得分，然后根据得分排序；而过滤（filter）只会筛选出符合的文档，并不计算得分，且它可以缓存文档。单从性能考虑，过滤比查询更快而且更节省io资源。过滤适合在大范围筛选数据，而查询则适合精确匹配数据。开发时应先使用过滤操作过滤数据，然后使用查询匹配数据</p><p>默认情况下，Elasticsearch的查询会计算返回的每条数据与查询语句的相关度，但对于非全文索引的使用场景，用户并不关心查询结果与查询条件的相关度，只是想精确的查找目标数据。此时，可以通过filter来让Elasticsearch不计算评分，并且尽可能的缓存filter的结果集，供后续包含相同filter的查询使用，提高查询效率。</p><p>普通查询：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &quot;http://localhost:9200/twitter/_search&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;user&quot;: &quot;kimchy&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤器(filter)查询：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &quot;http://localhost:9200/twitter/_search&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">         &quot;match&quot;: &#123;</span><br><span class="line">          &quot;user&quot;: &quot;kimchy&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分片查询缓存的目的是缓存聚合、提示词结果和命中数（它不会缓存返回的文档，因此，它只在<code>search_type=count</code>时起作用）。</p><p>通过下面的参数我们可以设置分片缓存的大小，默认情况下是JVM堆的1%大小，当然我们也可以手动设置在<code>config/elasticsearch.yml</code>文件里:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">indices.requests.cache.size: 1%</span><br></pre></td></tr></table></figure><p>查看缓存占用内存情况(<code>name</code>表示节点名, <code>query_cache</code>表示过滤器缓存，<code>request_cache</code>表示分片缓存，fielddata表示字段数据缓存，<code>segments</code>表示索引段)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &quot;http://localhost:9200/_cat/nodes?h=name,query_cache.memory_size,request_cache.memory_size,fielddata.memory_size,segments.memory&amp;v&quot;</span><br></pre></td></tr></table></figure><h2 id="3-2-使用路由routing"><a href="#3-2-使用路由routing" class="headerlink" title="3.2.使用路由routing"></a>3.2.使用路由routing</h2><h3 id="3-2-1-概念"><a href="#3-2-1-概念" class="headerlink" title="3.2.1.概念"></a>3.2.1.概念</h3><p>在将数据写入es时，指定一个字段作为路由字段，es会将该字段进行hash计算写入到对应的分片上；查询时根据查询条件中的路由值，直接查找所在的分片，大幅度提高查询速度。</p><p>需要注意的是：路由字段必须是随机分布，否则会导致分片数据不平均引发的主机存储使用不平均，可以作为路由字段的：如业务流水、省份、系统编码等。</p><h3 id="3-2-2-说明"><a href="#3-2-2-说明" class="headerlink" title="3.2.2.说明"></a>3.2.2.说明</h3><p>Elasticsearch写入文档时，文档会通过一个公式路由到一个索引中的一个分片上。默认的公式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard_num = hash(_routing) % num_primary_shards</span><br></pre></td></tr></table></figure><p><code>_routing</code>字段的取值，默认是_id字段，可以根据业务场景设置经常查询的字段作为路由字段。例如可以考虑将用户id、地区作为路由字段，查询时可以过滤不必要的分片，加快查询速度。</p><blockquote><p>写入时指定路由：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;http://localhost:9200/my_index/my_type/1?routing=user1&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;This is a document&quot;,</span><br><span class="line">  &quot;author&quot;: &quot;user1&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure><blockquote><p>查询时不指定路由，需要查询所有分片：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &quot;http://localhost:9200/my_index/_search&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;document&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>返回结果：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 2,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查询时指定路由，只需要查询1个分片：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &quot;http://localhost:9200/my_index/_search?routing=user1&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;document&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>返回结果：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 1,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-3-强制合并只读索引，关闭历史数据索引"><a href="#3-3-强制合并只读索引，关闭历史数据索引" class="headerlink" title="3.3.强制合并只读索引，关闭历史数据索引"></a>3.3.强制合并只读索引，关闭历史数据索引</h2><p>只读的索引可以从合并成一个单独的大segment中收益，减少索引碎片，减少JVM堆常驻内存。历史数据索引如果业务上不再支持查询请求，可以考虑关闭索引，减少JVM内存占用。</p><blockquote><p>索引 <code>forcemerge</code> API:</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &quot;http://localhost:9200/abc20180923/_forcemerge&quot;</span><br></pre></td></tr></table></figure><blockquote><p>索引关闭API:</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &quot;http://localhost:9200/abc2017*/_close&quot;</span><br></pre></td></tr></table></figure><h2 id="3-4-配置查询聚合节点"><a href="#3-4-配置查询聚合节点" class="headerlink" title="3.4.配置查询聚合节点"></a>3.4.配置查询聚合节点</h2><p>查询聚合节点可以发送粒子查询请求到其他节点，收集和合并结果，以及响应发出查询的客户端。通过给查询聚合节点配置更高规格的CPU和内存，可以加快查询运算速度、提升缓存命中率。</p><p>某客户使用25台8核CPU32G内存节点ELasticsearch集群，查询QPS在4000左右。增加6台16核CPU32G内存节点作为查询聚合节点，观察服务器CPU、JVM堆内存使用情况，并调整缓存、分片、副本参数，查询QPS达到12000。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查询聚合节点配置(conf/elasticsearch.yml)：</span><br><span class="line">node.master: false</span><br><span class="line">node.data: false</span><br><span class="line">node.ingest:false</span><br></pre></td></tr></table></figure><h2 id="3-5-设置查询读取记录条数和字段"><a href="#3-5-设置查询读取记录条数和字段" class="headerlink" title="3.5.设置查询读取记录条数和字段"></a>3.5.设置查询读取记录条数和字段</h2><h3 id="3-5-1-避免深分页查询"><a href="#3-5-1-避免深分页查询" class="headerlink" title="3.5.1.避免深分页查询"></a>3.5.1.避免深分页查询</h3><p>ES集群的分页查询支持from和size参数，查询的时候，每个分片必须构造一个长度为from+size的优先队列，然后回传到网关节点，网关节点再对这些优先队列进行排序找到正确的size个文档。</p><p>假设在一个有6个主分片的索引中，from为10000，size为10，每个分片必须产生10010个结果，在网关节点中汇聚合并60060个结果，最终找到符合要求的10个文档。</p><p>由此可见，当from足够大的时候，就算不发生OOM，也会影响到CPU和带宽等，从而影响到整个集群的性能。所以应该避免深分页查询，尽量不去使用。</p><h3 id="3-5-2-示例"><a href="#3-5-2-示例" class="headerlink" title="3.5.2.示例"></a>3.5.2.示例</h3><p>限制是为了保证es集群的稳定性。限制的内容包括：查询范围、单次查询数量等，过大的查询范围不仅会导致查询效率低，而且会是es集群资源耗费急剧增加，甚至引起es集群崩溃；单次查询数量限制是为了保证内存不会被查询内存大量占用，就是分页原理，es默认可以查询10000条数据。</p><p>默认的查询请求通常返回排序后的前10条记录，最多一次读取10000条记录，通过from和size参数控制读取记录范围，避免一次读取过多的记录。通过_source参数可以控制返回字段信息，尽量避免读取大字段。</p><blockquote><p>查询请求示例：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://localhost:9200/fulltext001/_search?pretty  -H &apos;Content-Type: application/json&apos; -d &apos; </span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 10,</span><br><span class="line">  &quot;_source&quot;: &quot;id&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;content&quot;:&quot;xxx&quot;&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-6-避免前缀模糊匹配"><a href="#3-6-避免前缀模糊匹配" class="headerlink" title="3.6.避免前缀模糊匹配"></a>3.6.避免前缀模糊匹配</h2><p>Elasticsearch默认支持通过*?正则表达式来做模糊匹配，如果在一个数据量超过10亿条的索引上执行模糊匹配，尤其是前缀模糊匹配，通常耗时会比较长，甚至可能导致内存溢出。尽量避免在高并发查询请求的生产环境执行这类操作。</p><p>某客户需要对车牌号进行模糊查询，通过查询请求”车牌号:<em>A8848</em>“查询时，往往导致整个集群负载较高。通过对数据预处理，增加冗余字段”车牌号.keyword”，并事先将所有车牌号按照1元、2元、3元…7元分词后存储至该字段，字段存储内容示例:沪,A,8,4,沪A,A8,88,84,48,沪A8…沪A88488。通过查询”车牌号.keyword:A8848”即可解决原来的性能问题。</p><h2 id="3-7-避免索引稀疏"><a href="#3-7-避免索引稀疏" class="headerlink" title="3.7.避免索引稀疏"></a>3.7.避免索引稀疏</h2><p>Elasticsearch6.X之前的版本默认允许在一个index下面创建多个type，Elasticsearch6.X及之后的版本只允许创建一个type。在一个type下面创建多个字段不一样的type，或者将几百个字段不一样的索引合并到一个索引中，会导致索引稀疏问题。</p><p>对于索引优化可以提前创建索引，避免索引稀疏，index中的document结构最好保持一致，如果document结构不一致，建议分index，用一个少量shard的index存放field格式不同的document。</p><p>建议每个索引下只创建一个type，字段不一样的数据分别独立创建index，不要合并成一个大索引。每个查询请求根据需要去读取相应的索引，避免查询大索引扫描全部记录，加快查询速度。</p><blockquote><p>扩展：</p></blockquote><p>在加载大量数据使<code>refresh_interval=-1</code>，<code>index.number_of_replicas=0</code>，索引完成后再设回来。Laod和IO压力不大的情况下，用<code>bulk</code>比单条的<code>PUT/DELETE</code>操作索引效率更高。</p><p>调整<code>index buffer</code>的大小，若不需要<code>field</code>的打分，则可以禁用<code>norms</code>；同样的若不需要<code>sort</code>或<code>aggregate</code>的<code>field</code>，则可以把<code>doc_value</code>属性禁用。</p><p>对于查询优化可以使用routing提升一维度数的查询速度；通过limit限制，避免返回太大量的搜索结果集；如果heap压力不大，可适当增加<code>node query cache</code>；增加shard备份可提高查询并发能力，但要注意node上的shard总量；最后是定期合并segment。</p><h2 id="3-8-扩容集群节点个数、升级节点规格"><a href="#3-8-扩容集群节点个数、升级节点规格" class="headerlink" title="3.8.扩容集群节点个数、升级节点规格"></a>3.8.扩容集群节点个数、升级节点规格</h2><p>通常服务器节点数越多，服务器硬件配置规格越高，Elasticsearch集群的处理能力越强。</p><p>在不同节点规模下的查询性能测试（测试环境：Elasticsearch5.5.3集群，单节点16核CPU、64G内存、2T SSD盘，10亿条人口户籍登记信息，数据大小1TB。）：</p><p>集群节点数|副本数|10并发检索平均响应时间|50并发检索平均响应时间|100并发检索平均响应时间|200并发检索平均响应时间|200并发QPS|200并发CPU使用率|200并发CPU IO等待|<br>—|—|—|—|—|—|—|—|—|—<br>1|0|77ms|459ms|438ms|1001ms|200|16%|52%<br>3|0|38ms|103ms|162ms|298ms|669|45%|34%|<br>3|2|271ms|356ms|577ms|818ms|244|19%|54%|<br>10|0|21ms|36ms|48ms|81ms|2467|40%|10%|</p><p>不同集群节点规模写入性能测试（测试环境：Elasticsearch6.3.2集群，单节点16核CPU、64G内存、2T SSD盘，10亿条人口户籍登记信息，单条记录1KB，数据集大小1TB，20个并发写入线程。）：<br>集群节点数|副本数|写入TPS|耗时|集群CPU使用率|<br>—|—|—|—|—|—|—|—|—|—<br>10|0|88945|11242s|50%<br>50|0|180638|5535s|20%</p><h2 id="3-9-数据生命周期"><a href="#3-9-数据生命周期" class="headerlink" title="3.9.数据生命周期"></a>3.9.数据生命周期</h2><p>es中的开启状态的索引都会占用堆内存来存储倒排索引，过多的索引会导致集群整体内存使用率多大，甚至引起内存溢出。所以需要根据自身业务管理历史数据的生命周期，如近3个月的数据开启用于快速查询；过去3-6月的数据索引关闭以释放内存，需要时再开启；超过6个月的可以生成快照保存至hdfs并删除索引，需要的时候从hdfs选择需要的索引恢复至集群中进行查询</p><p>生产上常常使用logstash+索引模板的方式按照一定时间创建新的索引，例如按天创建索引，索引的命名可能是index-yyyy-mm-dd，每天生产不同的索引，清除历史数据时可直接关闭或删除</p><p>需要注意的是：如何按照logstash默认的时间分割索引会有8个小时的误差，所以需要在logstash中将真实数据中的时间字段作为分割条件，保障按照业务时间分割索引</p><h1 id="4-实时性要求高的查询走DB"><a href="#4-实时性要求高的查询走DB" class="headerlink" title="4.实时性要求高的查询走DB"></a>4.实时性要求高的查询走DB</h1><p>对于ES写入机制的有了解的同学可能会知道，新增的文档会被收集到<code>Indexing Buffer</code>，然后写入到文件系统缓存中，到了文件系统缓存中就可以像其他的文件一样被索引到。</p><p>然而默认情况文档从<code>Indexing Buffer</code>到文件系统缓存（即<code>Refresh</code>操作）是每秒分片自动刷新，所以这就是我们说ES是==近实时搜索==而非实时的原因：文档的变化并不是立即对搜索可见，但会在一秒之内变为可见。</p><p>举例：当前订单系统ES采用的是默认Refresh配置，故对于那些订单数据实时性比较高的业务，直接走数据库查询，保证数据的准确性。</p><h1 id="5-ES-查询耗时很长，响应时间过久，该怎么做（类比mysql执行计划分析）"><a href="#5-ES-查询耗时很长，响应时间过久，该怎么做（类比mysql执行计划分析）" class="headerlink" title="5. ES 查询耗时很长，响应时间过久，该怎么做（类比mysql执行计划分析）"></a>5. ES 查询耗时很长，响应时间过久，该怎么做（类比mysql执行计划分析）</h1><p>包含但不限于：Nested慢查询、集群查询慢、range查询慢等问题。</p><p>1）可以用 profile 来查看具体是哪里执行慢<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-profile.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-profile.html</a></p><p>2）能用 filter 的都用 filter，减少打分的查询，比如你 must 里面的很多都是可以用 filter 来做的，根据上面的文档来优化。</p><blockquote><p>两个维度</p></blockquote><p>每当我们得到这些类型的问题时，我们首先要深入研究两个主要方面：</p><ul><li>配置维度 - 查看当前系统资源和默认Elasticsearch选项。</li><li>开发维度 - 查看查询，其结构以及要搜索的数据的映射（Mapping）。</li></ul><p>我们将首先关注开发方面的问题。 我们将获得慢查询，讨论DSL查询语言，并查看有助于改进Elasticsearch查询的小型常规选项。</p><blockquote><p>日志</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1[2018-05-21T12:35:53,352][DEBUG ][index.search.slowlog.query] </span><br><span class="line">2[DwOfjJF] [blogpost-slowlogs][4] took[1s], took_millis[0], types[], </span><br><span class="line">3stats[], search_type[QUERY_THEN_FETCH], total_shards[5], </span><br><span class="line">4source[&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;name&quot;:&#123;&quot;query&quot;:&quot;hello world&quot;,</span><br><span class="line">5 &quot;operator&quot;:&quot;OR&quot;,&quot;prefix_length&quot;:0,&quot;max_expansions&quot;:50,</span><br><span class="line">6&quot;fuzzy_transpositions&quot; :true,&quot;lenient&quot;:false,&quot;zero_terms_query&quot;:</span><br><span class="line">7 &quot;NONE&quot;,&quot;boost&quot;:1.0&#125;&#125;&#125;,&quot;sort&quot;:[&#123;&quot;price&quot;: &#123;&quot;order&quot;:&quot;desc&quot;&#125;&#125;]&#125;],</span><br></pre></td></tr></table></figure><blockquote><p>通过分解的日志可以看到</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1 日期</span><br><span class="line">2 时间戳 </span><br><span class="line">3 日志级别 </span><br><span class="line">4 慢速类型 </span><br><span class="line">5 节点名称 </span><br><span class="line">6 索引名称 </span><br><span class="line">7 分片号 </span><br><span class="line">8 时间花费 </span><br><span class="line">9 查询的主体（_source&gt;）</span><br></pre></td></tr></table></figure><p>一旦我们获得了我们认为花费的时间太长的查询，我们就可以使用一些工具来分解查询：</p><ul><li>工具1：Profile API</li></ul><p>Profile API提供有关搜索的信息页面，并分解每个分片中发生的情况，直至每个搜索组件（match/range/match_phrase等）的各个时间。 搜索越详细，_profile输出越详细。</p><ul><li>工具2：Kibana profiling 工具</li></ul><p>这与_profileAPI密切相关。 它提供了各个搜索组件的完美的可视化效果表征各个分解阶段以及各阶段查询的时间消耗。 同样，这可以轻松选择查询的问题区域。</p><p>摘自 : <a href="https://cloud.tencent.com/developer/article/1357698" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1357698</a></p><h1 id="6-OP关注"><a href="#6-OP关注" class="headerlink" title="6.OP关注"></a>6.OP关注</h1><p>运维Elasticsearch集群主要关注一下几个方面：</p><ul><li>集群健康状态。</li><li>集群索引和搜索性能。</li><li>节点CPU、memory以及disk的使用情况。</li><li>集群健康状态分为三种，集群green代表健康，集群yellow主要是有replica shard未分配，但不影响集群正常使用，集群red主要是因为有primary shard未分配，会影响集群正常使用。主要原因是集群node disk使用率超过默认值85%，这样一来新的shard就无法分配。这种情况可以通过以下方式查看：<ul><li>通过api GET/_cat/allocation查看node的磁盘使用率。</li><li>通过api GET/_cluster/settings查看<br>cluster.routing.allocation.enable是否被禁止。</li><li>通过api GET/_cluster/allocation/explain?pretty查看shard未分配到node的具体原因。</li></ul></li></ul><hr><p>参考：</p><p>Elasticsearch参考[7.3] »如何 »调整搜索速度<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-search-speed.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-search-speed.html</a> 等<br>Organized from <a href="https://elasticsearch.cn/" target="_blank" rel="noopener">https://elasticsearch.cn/</a></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">---------------------到这里就结束了噢----<i class="fa fa-paw"></i>-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/elasticsearch/" rel="tag"><i class="fa fa-tag"></i> elasticsearch</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/08/30/es/Elasticsearch(一)/" rel="next" title="elasticsearch（一）"><i class="fa fa-chevron-left"></i> elasticsearch（一）</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2019/08/30/es/Spring Data Elasticsearch（es5.6.3）/" rel="prev" title="Spring Data Elasticsearch">Spring Data Elasticsearch <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="wind-mills"></a><p class="site-author-name" itemprop="name">wind-mills</p><p class="site-description motion-element" itemprop="description">人分两类，迷人乏味</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">11</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">3</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">7</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="undefined" target="_blank" title="GitHub"><i class="fa fa-fw fa-globe"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:catball10@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Elasticsearch部署建议"><span class="nav-number">1.</span> <span class="nav-text">1.Elasticsearch部署建议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1选择合理的硬件配置，尽可能使用SSD"><span class="nav-number">1.1.</span> <span class="nav-text">1.1选择合理的硬件配置，尽可能使用SSD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-给JVM配置机器一半的内存，但是不建议超过32G"><span class="nav-number">1.2.</span> <span class="nav-text">1.2.给JVM配置机器一半的内存，但是不建议超过32G</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-规模较大的集群配置专有主节点，避免脑裂问题"><span class="nav-number">1.3.</span> <span class="nav-text">1.3.规模较大的集群配置专有主节点，避免脑裂问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-master节点与data节点分离"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.3.1.master节点与data节点分离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-2-GC算法"><span class="nav-number">1.3.2.</span> <span class="nav-text">1.3.2.GC算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-3-设置discovery-zen-ping-timeout"><span class="nav-number">1.3.3.</span> <span class="nav-text">1.3.3.设置discovery.zen.ping_timeout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-4-设置选举触发条件"><span class="nav-number">1.3.4.</span> <span class="nav-text">1.3.4.设置选举触发条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-5-修改data节点的默认的master发现方式"><span class="nav-number">1.3.5.</span> <span class="nav-text">1.3.5.修改data节点的默认的master发现方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-Linux参数调优"><span class="nav-number">1.4.</span> <span class="nav-text">1.4.Linux参数调优</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-参数调优"><span class="nav-number">1.5.</span> <span class="nav-text">1.5.参数调优</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-JVM内存溢出处理"><span class="nav-number">1.6.</span> <span class="nav-text">1.6.JVM内存溢出处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-GC调优"><span class="nav-number">1.7.</span> <span class="nav-text">1.7.GC调优</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-索引性能调优建议"><span class="nav-number">2.</span> <span class="nav-text">2.索引性能调优建议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-设置合理的索引分片数和副本数"><span class="nav-number">2.1.</span> <span class="nav-text">2.1.设置合理的索引分片数和副本数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-使用批量请求"><span class="nav-number">2.2.</span> <span class="nav-text">2.2.使用批量请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-考虑"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 考虑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-说明"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-通过多进程-线程发送数据"><span class="nav-number">2.3.</span> <span class="nav-text">2.3.通过多进程/线程发送数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-调大refresh-interval"><span class="nav-number">2.4.</span> <span class="nav-text">2.4.调大refresh interval</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-设计mapping配置合适的字段类型"><span class="nav-number">2.5.</span> <span class="nav-text">2.5.设计mapping配置合适的字段类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-索引配置"><span class="nav-number">2.6.</span> <span class="nav-text">2.6.索引配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-查询性能调优建议"><span class="nav-number">3.</span> <span class="nav-text">3.查询性能调优建议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-使用过滤器缓存和分片查询缓存"><span class="nav-number">3.1.</span> <span class="nav-text">3.1.使用过滤器缓存和分片查询缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-使用路由routing"><span class="nav-number">3.2.</span> <span class="nav-text">3.2.使用路由routing</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-概念"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1.概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-说明"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2.说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-强制合并只读索引，关闭历史数据索引"><span class="nav-number">3.3.</span> <span class="nav-text">3.3.强制合并只读索引，关闭历史数据索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-配置查询聚合节点"><span class="nav-number">3.4.</span> <span class="nav-text">3.4.配置查询聚合节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-设置查询读取记录条数和字段"><span class="nav-number">3.5.</span> <span class="nav-text">3.5.设置查询读取记录条数和字段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-避免深分页查询"><span class="nav-number">3.5.1.</span> <span class="nav-text">3.5.1.避免深分页查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-示例"><span class="nav-number">3.5.2.</span> <span class="nav-text">3.5.2.示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-避免前缀模糊匹配"><span class="nav-number">3.6.</span> <span class="nav-text">3.6.避免前缀模糊匹配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-避免索引稀疏"><span class="nav-number">3.7.</span> <span class="nav-text">3.7.避免索引稀疏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-扩容集群节点个数、升级节点规格"><span class="nav-number">3.8.</span> <span class="nav-text">3.8.扩容集群节点个数、升级节点规格</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-9-数据生命周期"><span class="nav-number">3.9.</span> <span class="nav-text">3.9.数据生命周期</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-实时性要求高的查询走DB"><span class="nav-number">4.</span> <span class="nav-text">4.实时性要求高的查询走DB</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-ES-查询耗时很长，响应时间过久，该怎么做（类比mysql执行计划分析）"><span class="nav-number">5.</span> <span class="nav-text">5. ES 查询耗时很长，响应时间过久，该怎么做（类比mysql执行计划分析）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-OP关注"><span class="nav-number">6.</span> <span class="nav-text">6.OP关注</span></a></li></ol></div></div></section></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="300" height="300" id="resCanvas"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch插件/">elasticsearch插件</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eureka/">eureka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-data-elasticsearch/">spring-data-elasticsearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springcloud/">springcloud</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/搜索引擎/">搜索引擎</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">wind-mills</span></div><div class="powered-by"><i class="fa fa-user"></i> <span id="busuanzi_container_site_uv">访客数:<span id="busuanzi_value_site_uv"></span>人 </span>| <i class="fa fa-eye"></i> <span id="busuanzi_container_site_pv">访问量<span id="busuanzi_value_site_pv"></span>次 </span>|<div class="theme-info"><span class="post-count">全站共31.9k字</span></div></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("","")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script>undefined<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/tororo.model.json"},display:{position:"right",width:180,height:350,hOffset:100,vOffset:-160},mobile:{show:!0,scale:.5},log:!1})</script></body></html><!-- rebuild by neat -->